# 2. spInterp

```{julia}
using Ipaper, SpatRasters, NetCDFTools, Test
using MakieLayers, CairoMakie

function make_rast(; b::bbox=bbox(70, 15, 140, 55), cellsize=0.5)
  lon, lat = bbox2dims(b; cellsize)
  nlon, nlat = length(lon), length(lat)
  rast(zeros(nlon, nlat), b)
end

indir = "$(@__DIR__)/../../../data" |> abspath
```

```{julia}
# using RTableTools
# st = fread("data/st_met2481.csv")
# serialize("data/st_met2481", st[:, [:site, :lon, :lat, :alt]])
st = deserialize("$indir/st_met2481")
sites = [st.lon st.lat]
alt = st[:, :alt]
data = repeat(alt, 1, 24)' |> collect
```

```{julia}
ra = make_rast(; cellsize=0.5)

weights = weights_idw(ra, sites)
@test length(rm_empty(weights[:])) == 7861

weights = weights_idw(ra, sites)
weights = weights_adw(ra, sites)
@time zs = spInterp(weights, data)

@test size(zs) == (nlon, nlat, 24)
@test mean(zs[:, :, 1]) ≈ 814.0711051650405
```

## 完整案例

- 0.5deg, 1year 365×24, 2481 sites
```{julia}
data = repeat(alt, 1, 24 * 365)' |> collect
ra = make_rast(; cellsize=0.5)
weights = weights_idw(ra, sites)
@time zs = spInterp(weights, data); # 1day, hourly
```

- 0.1deg, 1year 365×24, 2481 sites

> 67.654694 seconds (425.24 k allocations: 18.288 GiB, 0.42% gc time)

```{julia}
lon, lat = st_dims(ra)
imagesc(lon, lat, zs[:, :, 1])
```
